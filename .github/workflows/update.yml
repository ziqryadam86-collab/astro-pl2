name: Update Astro Token
on:
  schedule:
    - cron: '*/5 * * * *' # Robot bangun setiap 5 minit
  workflow_dispatch: # Suis untuk jalan manual

jobs:
  update-link:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch Astro Link
        run: |
          # Ambil data dari website sumber
          SOURCE_DATA=$(curl -sL "https://www.kds.tw/tv/sports-tv-live-streaming/astro-pl-2/")
          
          # Cuba cari link m3u8 (Cara 1 & Cara 2 gabung)
          RAW_URL=$(echo "$SOURCE_DATA" | grep -oE 'https?://[^"]+\.m3u8[^"]*' | head -n 1)
          
          # Jika gagal cara pertama, cuba cari link yang ada perkataan 'token'
          if [ -z "$RAW_URL" ]; then
            RAW_URL=$(echo "$SOURCE_DATA" | grep -oE 'https?://[^ ]+astro[^ ]+m3u8[^ ]*' | head -n 1 | sed 's/[\\"]//g')
          fi

          # Bina fail m3u8
          echo "#EXTM3U" > astro.m3u8
          echo "#EXT-X-STREAM-INF:BANDWIDTH=1280000,RESOLUTION=1280x720" >> astro.m3u8
          
          # Masukkan link jika dijumpai, jika tidak masukkan mesej ralat
          if [ -z "$RAW_URL" ]; then
            echo "ERROR_NO_LINK_FOUND" >> astro.m3u8
          else
            echo "$RAW_URL" >> astro.m3u8
          fi
          
          echo "Hasil fail astro.m3u8:"
          cat astro.m3u8

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add astro.m3u8
          git commit -m "Update Astro Token $(date)" || exit 0
          git push
          
